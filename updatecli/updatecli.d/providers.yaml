name: Bump CAPI providers version

pipelineid: "capi-providers"

actions:
  default:
    title: 'deps: bump capi providers versions'
    kind: github/pullrequest
    scmid: turtles
    spec:
      automerge: false
      mergemethod: squash
      labels:
        - kind/chore
        - area/update

scms:
  turtles:
    kind: github
    spec:
      branch: '{{ .scm.branch }}'
      email: '{{ .scm.email }}'
      owner: '{{ .scm.owner }}'
      repository: '{{ .scm.repository }}'
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      user: '{{ .scm.user }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      commitusingapi: true

sources:
  caprke2release:
    kind: githubrelease
    name: Get the latest CAPI RKE2 bootstrap/control plane provider release
    spec:
      owner: "rancher"
      repository: "cluster-api-provider-rke2"
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      typeFilter:
        latest: true
  capzrelease:
    kind: githubrelease
    name: Get the latest CAPI Azure infrastructure provider release
    spec:
      owner: "rancher-sandbox"
      repository: "cluster-api-provider-azure"
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      typeFilter:
        latest: true
  caparelease:
    kind: githubrelease
    name: Get the latest CAPI AWS infrastructure provider release
    spec:
      owner: "rancher-sandbox"
      repository: "cluster-api-provider-aws"
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      typeFilter:
        latest: true
  capvrelease:
    kind: githubrelease
    name: Get the latest CAPI vSphere infrastructure provider release
    spec:
      owner: "rancher-sandbox"
      repository: "cluster-api-provider-vsphere"
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      typeFilter:
        latest: true
  capielementalrelease:
    kind: githubrelease
    name: Get the latest CAPI Elemental infrastructure provider release
    spec:
      owner: "rancher-sandbox"
      repository: "cluster-api-provider-elemental"
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      typeFilter:
        latest: true
  capifleetrelease:
    kind: githubrelease
    name: Get the latest CAPI add-on provider Fleet release
    spec:
      owner: "rancher-sandbox"
      repository: "cluster-api-addon-provider-fleet"
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      typeFilter:
        latest: true

targets:
  bumpcaprke2:
    name: bump caprke2 provider
    kind: file
    spec:
      file: ./internal/controllers/clusterctl/config.yaml
      matchpattern: 'https://github.com/rancher/cluster-api-provider-rke2/releases/(.*)/'
      replacepattern: 'https://github.com/rancher/cluster-api-provider-rke2/releases/{{ source "caprke2release" }}/'
    scmid: turtles
    sourceid: caprke2release
  bumpcaprke2etcdrestoregomod:
    name: bump github.com/rancher/cluster-api-provider-rke2 in etcdrestore go.mod
    kind: golang/gomod
    scmid: turtles
    sourceid: caprke2release
    spec:
      module: github.com/rancher/cluster-api-provider-rke2
      file: exp/etcdrestore/go.mod
      version: {{ source `caprke2release` }}
  etcdrestoregomodtidy:
    dependson:
      - bumpcaprke2etcdrestoregomod
    disablesourceinput: true
    kind: shell
    name: Run `go mod tidy`
    scmid: turtles
    spec:
      changedif:
        kind: file/checksum
        spec:
          files:
            - go.mod
            - go.sum
      command: go mod tidy
  bumpcapz:
    name: bump capz provider
    kind: file
    spec:
      file: ./internal/controllers/clusterctl/config.yaml
      matchpattern: 'https://github.com/rancher-sandbox/cluster-api-provider-azure/releases/(.*)/'
      replacepattern: 'https://github.com/rancher-sandbox/cluster-api-provider-azure/releases/{{ source "capzrelease" }}/'
    scmid: turtles
    sourceid: capzrelease
  bumpcapa:
    name: bump capa provider
    kind: file
    spec:
      file: ./internal/controllers/clusterctl/config.yaml
      matchpattern: 'https://github.com/rancher-sandbox/cluster-api-provider-aws/releases/(.*)/'
      replacepattern: 'https://github.com/rancher-sandbox/cluster-api-provider-aws/releases/{{ source "caparelease" }}/'
    scmid: turtles
    sourceid: caparelease
  bumpcapv:
    name: bump capv provider
    kind: file
    spec:
      file: ./internal/controllers/clusterctl/config.yaml
      matchpattern: 'https://github.com/rancher-sandbox/cluster-api-provider-vsphere/releases/(.*)/'
      replacepattern: 'https://github.com/rancher-sandbox/cluster-api-provider-vsphere/releases/{{ source "capvrelease" }}/'
    scmid: turtles
    sourceid: capvrelease
  bumpcapielemental:
    name: bump capi elemental provider
    kind: file
    spec:
      file: ./internal/controllers/clusterctl/config.yaml
      matchpattern: 'https://github.com/rancher-sandbox/cluster-api-provider-elemental/releases/(.*)/'
      replacepattern: 'https://github.com/rancher-sandbox/cluster-api-provider-elemental/releases/{{ source "capielementalrelease" }}/'
    scmid: turtles
    sourceid: capielementalrelease
  bumpcapifleet:
    name: bump capi fleet addon provider
    kind: file
    spec:
      file: ./internal/controllers/clusterctl/config.yaml
      matchpattern: 'https://github.com/rancher-sandbox/cluster-api-addon-provider-fleet/releases/(.*)/'
      replacepattern: 'https://github.com/rancher-sandbox/cluster-api-addon-provider-fleet/releases/{{ source "capifleetrelease" }}/'
    scmid: turtles
    sourceid: capifleetrelease

